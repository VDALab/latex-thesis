%!TEX root = Thesis.tex

\chapter{Parallel Hierarchical Synthesis}\label{chap:hsf} 

  To elaborate the advantages of both deterministic optimization and circuit simulation, this work tends to integrated them as a hierarchical process. The framework inherit synthesis flow in \cite{PerfMap_ISQED2011} mostly. Here the updated flow replace the original performance exploration with PGA methodology. Also, the fine-tuning simulation is improve as probabilistic perturbation simulation. Therefore, our proposed flow is shown in Fig.~\ref{fig:PageFlow}, and the corresponding notations are list in Table~\ref{table:notation}.

  


  \section{Device Fitting}\label{sec:devFit}
    
    At the beginning of synthesis framework, we have an abstraction from device model to circuit-level variables. Given the required devices of the target circuit design, the foundry device models provide such device characteristics with SPICE modeling. A set of analytical design equations are capable to map device-level variables into circuit-level design variables by modeling techniques such as symbolic analysis or curve fitting like~\cite{PWL_Convex_GP,Eeckelaert_DATE2003,Daems_DAC2002}. Two steps of technique accomplish the abstraction for design variables. 

    First of all, it is necessary to discover feasible variable values for each attendant device. In other words, all design variable values which cause device failed should be exclusive at this stage. By SPICE simulator, a matrix of accessible device level variable value are generated. However, since this step is collecting the feasible range of each device level parameters, the table is collected in one-time. 
    
    \begin{figure}[t]
      \centering
      \includegraphics[width=\textwidth]{Fig/PageFlow.eps}
      \caption{Hierarchical performance exploration flow with PGA} 
      \label{fig:PageFlow}
    \end{figure}

    Secondly, such matrix of device-level variables are further mapped into circuit-level variables by curve fitting. An vivid example for design variable mapping is shown in Fig.~\ref{fig:DeviceFit}. Given a set of device-level variables $V^D= \{{v^D}_i| 1 \leq i \leq |V^D|\}$ , each $v^D_i$ has the same step number $S_{V^D}$ in each range. That is, while $v_i^D$ has maximum value $V^D_{MAX}$ and minimum value $V^D_{min}$, there should be $S_{V^D}$ values among then. Therefore, a set of feasible device-level variables are constructed in a matrix $T_{|V^D|\times S_{V^D}}$, where $T_{|V^D| \times S_{V^D}} = \{ t_{i,j}| 1 \leq i \leq |V^D|, 1 \leq j \leq S_{V^D} \}$. Meanwhile, a set of circuit-level variables $V^C = \{{v^C}_j| 1 \leq j \leq |V^C|\}$ should be extracted for performance exploration. As Eq.(\ref{eq:devToCir}),all training pairs of the extracted circuit-level variables from previous transformation and device-level variables are then formulated as least-square error problem in analytical posynomial form design equations to acquire fitting parameters.

    {\footnotesize
    \begin{align}\label{eq:devToCir}
      \begin{array}[t]{rl}
        Variables: & \begin{array}[t]{rl}
                      T_{|V^D| \times S_{V^D}}  & = \{t_{i,j}| 1 \leq i \leq |V^D|,\; 1 \leq j \leq S_{V^D}\}   \\
                      V^C   &= \{v_j^C, 1\leq j \leq |V^C| \}   \\
                      v_j^C &= \{f_j^{(C_f)}(T_{|V^D| \times S_{V^D}})|1 \leq j \leq |V^C|\}  \\
                    \end{array} \\
         minimize & \| \sum{ v_j^C - f_j^{(C_f)}(T_{|V^D| \times S_{V^D}})}\|^2   \\
       subject\; to & C_f\in \left [{C_f}_{min}, {C_f}_{MAX} \right] 
      \end{array} 
    \end{align}}
    
    
    where
    \begin{itemize}
      \item $C_f$ is the fitting parameters of $f_j$ 
      \item $\left [{C_f}_{min},{C_f}_{MAX}\right]$ is the range constraints of the fitting parameters in $f_j, 1 \leq j \leq |V^C|$.
    \end{itemize}

    Since parasitics are non-ignorable, the parasitic effects of devices should also be extracted for the following steps in order to exploit the trade-off between each aspect of circuit design variables and performance metrics.~\cite{Template_Based_Parasitic_Aware_Layout}. The problem formulation is similar to Eq.(\ref{eq:devToCir}) in Eq.(\ref{eq:paraExt}):
  
    \vspace{0.3cm}
    {\footnotesize
      \begin{align}\label{eq:paraExt}
        \begin{array}[t]{rl}
        Variables:  & \begin{array}[t]{ll}
                        T_{|V^D| \times S_{V^D}} &= \{t_{i,j}| 1 \leq i \leq |V^D|,\; 1 \leq j \leq S_{V^D}\}   \\
                        V^P     & = \{v^p_l|1 \leq l \leq |V^P|\} \\
                        v^p_l   & = \{Q_l^{(C_p)}(T_{|V^D| \times S_{V^D}})| 1 \leq l \leq |V^P| \}
                      \end{array} \\
        minimize    &  \| \sum{v^p_l-Q_l^{(C_v^p)}(T_{|V^D| \times S_{V^D}})}\|^2  \\
        subject to  &  C_v^p \in \left [ {C_v^p}_{min}, {C_v^p}_{MAX}\right] 
        \end{array} 
      \end{align}
    }
    where

    \begin{itemize}\setlength{\itemsep}{2pt}
      \item $v^p_l$ is the mapping equations from $T_{|V^D|\times S_{V^D}}$ to $V^P$, 
      \item $C_p$ is the fitting parameters of $Q_l$,
      \item $\left [ {C_{v^p}}_{min}, {C_{v^p}}_{MAX}\right]$ is the range constraints of the fitting parameters in $Q_l$.
    \end{itemize}

  
    \begin{figure}[t]
      \centering
      \includegraphics[width=\textwidth]{Fig/DeviceFit.eps}
      \caption{Mapping device-level variables of one NMOS(number of fingers, device channel width/length and current) to circuit-level variables ($G_m$, $R_o$, $C_D$, $C_G$ and $\Sigma$) } 
      \label{fig:DeviceFit}
    \end{figure}

  
  \input{Thesis_PGA.tex}

  \section{Design Re-targeting}\label{sec:reTarg}
    
    After generating specialized populations by PGA evolution, it comes to a reverse interpolation from a series of performance specifications through circuit-level design variables to device-level design variables. Hence, K groups of optimal-potential performance spaces of the circuit under chosen technology are traversed. Since a set of performance metrics directly represents the limitation of specifications, such group of optimal performance specification is locked from optimal performance. Ideally, the optimization engine should be capable of directly finding the geometry-biasing-level design variables. 

    Next, we want to find the optimal candidates of device-level design variables. From previous stage, the circuit-level design variables are obtained. Here the distribution of the device-level design variables are also obtained through this design re-targeting stage. As Eq.(\ref{eq:SingleReTarg}) illustrated, since each device has its particular device variables, all of them are considered for optimization. $M$ stands for a set of attendant devices in the circuit. Generally, each device has different number of variables. Therefore, $V^D_{m_k}$ represents the variable set of single $m_j$. Referring to Section~\ref{sec:pga}, Performance results $R_{S \times K}$ are obtained along with the same number($N_P$) of $V^C$ and $V^P$. Each $v^C$ and $v^P$ will re-target to a set of device-level parameter values via $f_{RE}(v^C, v^P)$ transformation. Eq.(\ref{eq:SingleReTarg}) shows a single transformation from each $v^C$ and $v^P$ to a set of device-level parameters $V^D_M$,

    \begin{align}{\label{eq:SingleReTarg}}
      \begin{array}[t]{rl}
        Variables & \begin{array}[t]{rl}
                      M         &= \{ m_j| 1 \leq j \leq |M|\} \\
                      V^D_M     &= \{ v^D_{m_j} | 1 \leq j \leq |M|\} \\
                      v^D_{m_j} &= \{v^D_{m_{j,k}}| 1 \leq k \leq |v^D_{m_j}|\}\\
                      v^C       &= f^{(C_f)}(V^D_M)\\
                      v^P       &= Q^{(C_Q)}(V^D_M)\\
                    \end{array} \\
         minimize & Q(V^D_M \to V^P)  \\
       subject\; to & V^D_M\in \left [{V^D_M}_{min}, {V^D_M}_{MAX} \right] 
      \end{array} 
    \end{align}

    \begin{figure}[t]
      \centering
      \includegraphics[width=\textwidth]{Fig/Retarg.eps}
      \caption{Given merged populations of performance specs, a reversed process is to retrieve the corresponding design variables of each device (PMOS) in the circuit for optimal sizing values.} 
      \label{fig:Retarg}
    \end{figure}
    
    In Eq.(\ref{eq:SingleReTarg}), $Q$ is a cost function that involves the parasitic effects of the device, such as a product of area, parasitic cap/resistance, or self-resonance frequency, etc. For all, Every individual $V^C$ and $V^P$ need to be transfer to device-level parameters as distributions. In Eq.(\ref{eq:FullReTarg}), $\Psi$ collects $N_P$ set of device variables for required circuit.

    \begin{align}{\label{eq:FullReTarg}}
      \begin{array}{l}
        V^C = \{v^C_i| 1 \leq i \leq N_P\}\\
        V^P = \{v^P_i| 1 \leq i \leq N_P\}\\
        \Psi =  \{V^D_{M_{i,j,k}}| 1\leq i \leq N_P, 1 \leq k \leq |M|, 1 \leq j \leq |v^D_{m_k}|\} 
      \end{array}
    \end{align}

    Also, as shown in Fig.~\ref{fig:Retarg}, multiple solutions as distributions are generated from {\it Performance Space Exploration} in Section~\ref{sec:pga}, and it stands for a set of potential parameters for devices in required circuit. However, $\Psi$ not only narrows down the solution space for circuit simulation, but provides good prediction for optimal performance which will be validated via probabilistic simulation in Section~\ref{sec:pss} efficiently. 

  \input{Thesis_ProbSimu.tex}

  A hierarchical synthesis for circuit sizing strategy is accomplished after the optimal solution is converged when stochastic simulator or the termination requirement is met. Based on a probabilistic stochastic fine-tuning, the convergence time successfully reduced comparing to non-probabilistic approach because certain simulations of corner cases are examined via selection. 